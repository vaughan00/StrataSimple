 Hybrid Magic Link Login with Role-Based Access Control (SMTP Enabled)

Implement a hybrid magic link login system with role-based access control.
SMTP email delivery is already configuredâ€”use it to send secure, time-limited login links.
Users will log in by selecting their unit, confirming a masked email, and receiving a magic link.
Each user has a role that defines their access level.

â¸»

âœ… 1. User Model

Create model something like:

class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    email = db.Column(db.String, unique=True, nullable=False)
    role = db.Column(db.String, default='owner')  # 'owner', 'committee', 'admin'
    token = db.Column(db.String)
    token_expiry = db.Column(db.DateTime)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)


â¸»

âœ… 2. Hybrid Login Flow (Unit + Email)
	â€¢	User selects their unit on the login page
	â€¢	App retrieves the registered email for that unit
	â€¢	Display a masked version of the email:

We'll send a login link to: f*******t@g****.com
[Send Login Link]


	â€¢	On confirmation:
	â€¢	Generate a secure token, store it with an expiry
	â€¢	Send the login link via SMTP:

https://yourapp.com/auth/verify?token=abc123


	â€¢	When the user clicks the link:
	â€¢	Validate the token
	â€¢	Log the user in by saving user_id, user_email, and user_role in the session

â¸»

âœ… 3. Email Obfuscation Function, something like:

def obfuscate_email(email):
    local, domain = email.split('@')
    masked_local = local[0] + '*' * (len(local) - 2) + local[-1]
    masked_domain = domain[0] + '*' * (len(domain.split('.')[0]) - 1) + domain[domain.find('.'):]
    return f\"{masked_local}@{masked_domain}\"


â¸»

âœ… 4. Role-Based Access Control something like:

Implement a @require_role() decorator:

def require_role(*roles):
    def decorator(f):
        @wraps(f)
        def wrapper(*args, **kwargs):
            if session.get('user_role') not in roles:
                return abort(403)
            return f(*args, **kwargs)
        return wrapper
    return decorator

Use it to protect routes like /settings, /fees, etc.

â¸»

âœ… 5. User Roles and Permissions

Feature / Page	Owner	Committee	Admin
View own unit details	âœ…	âœ…	âœ…
View all properties	âŒ	âœ…	âœ…
View all fees & expenses	âŒ	âœ…	âœ…
View all contacts	âŒ	âœ…	âœ…
Manage fees & expenses	âŒ	âŒ	âœ…
Manage properties & contacts	âŒ	âŒ	âœ…
Run reconciliation	âŒ	âŒ	âœ…
Access audit logs	âŒ	âœ…	âœ…


â¸»

âœ… 6. Logout

Create a route that clears the session and redirects the user.

â¸»

ğŸŸ¢ 7
	â€¢	Token revocation after use
	â€¢	Support multiple users per property
	â€¢	Login activity logs
	â€¢	â€œResend linkâ€ flow

â¸»